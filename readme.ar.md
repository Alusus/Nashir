# Nashir
[[English]](readme.md)

<div dir=rtl>

مكتبة لتسهيل بناء ونشر المشاريع. تعتمد هذه المكتبة تصيميما يتيح إضافة مشغلات لخدمات الاستضافة المختلفة.
يتوفر حاليا مشغلان، أحدهما مخصص لخدمة الأسس نت، بينما الآخر عام يعتمد على بروتوكول SSH لنشر المشاريع.

## الاستخدام

تفترض هذه الخطوات أن لديك بالفعل تطبيق ويب وتريد نشره.

* أضف المكتبة إلى مشروعك، مع تحميل المشغل المطلوب:

```
اشمل "مـحا"؛
مـحا.اشمل_ملف("Alusus/Nashir"، { "نـاشر.أسس"، "مـشغلات_نشر/الـأسس_نت.أسس" })؛
```

<div dir=ltr>

```
import "Apm";
Apm.importFile("Alusus/Nashir", { "Nashir.alusus", "PublishDrivers/AlususNet.alusus" });
```

</div>

أو لتحميل مشغل SSH:

```
اشمل "مـحا"؛
مـحا.اشمل_ملف("Alusus/Nashir"، { "نـاشر.أسس"، "مـشغلات_نشر/بـروتوكول_النقل_الآمن.أسس" })؛
```

<div dir=ltr>

```
import "Apm";
Apm.importFile("Alusus/Nashir", { "Nashir.alusus", "PublishDrivers/Ssh.alusus" });
```

</div>

* اضبط مكتبة الناشر في نهاية برنامجك باستخدام الماكرو `اضبط`. يمكنك تحديد قيمة إطناب بـ 1 للحصول على
  معلومات مفصلة أكثر أثناء نشر المشروع. يستلم الماكرو معطى واحدا وهو كائن من صنف `إعـدادات` (`Config`).
  هذا الماكرو سيتولى مسؤولية ضبط إعدادات الناشر وإعدادات مكتبة بـروجارج (ProgArg) التي يستخدمها الناشر
  لمعالجة معطيات المستخدم. وفي حال كان البرنامج يستخدم مكتبة مـنصة_ويب فسيتولى هذا الماكرو أيضًا إنشاء
  الدالتين الرئيسيتين المسؤولتين عن بدء البرنامج وتشغيل الخادم، هذا إن لم يوفر المستخدم هاتين الدالتين
  بنفسه. يحتاج الناشر دالتين منفصلتين، واحدة لتشغيل الخادم مباشرة دون بناء، والأخرى لتكون مدخل البرنامج
  في حالة البناء.

```
نـاشر.إطناب = 0؛
نـاشر.اضبط[نـاشر.إعـدادات().{
    اسم_المشروع = "MyProject"؛
    رقم_الإصدار = "v1"؛
    منفذ_الخادم = 8000؛
    الموارد.حدد(نـص("موارد_أخرى")، نـص("موارد_أخرى"))؛
    مشغل_النشر = نـاشر.مـشغل_نشر_الأسس_نت()؛
}]؛
```

<div dir=ltr>

```
Nashir.verbose = false;
Nashir.setup[Nashir.Config().{
    projectName = "Chat";
    projectVersion = "v1";
    serverPort = 8000;
    assets.add(String("OtherAssets"), String("OtherAssets"));
    publishDriver = Nashir.AlususNetPublishDriver();
}];
```

</div>

* الناشر يعتمد على مكتبة بـروجارج (ProgArg) لتحليل معطيات البرنامج، وبعد استدعاء ماكرو `اضبط` (`setup`)
  يكون الناشر قد أكمل تهيئة الأوامر في بـروجارج ويمكن الآن الطلب من بـروجارج معالجة معطيات المستخدم.

```
بـروجارج.حلل(2)؛
```

<div dir=ltr>

```
ProgArg.parse(2);
```

</div>

* بعد إتمام هذه الخطوات سيمكنك تشغيل التطبيق مباشرة كما يلي:

```
الأسس بداية.أسس ابدأ
```

<div dir=ltr>

```
alusus main.alusus start
```

</div>

ويمكنك أيضًا بناء نسخة تنفيذية من المشروع:

```
الأسس بداية.أسس ابن
```

<div dir=ltr>

```
alusus main.alusus build
```

</div>

ويمكنك أيضًا نشر المشروع إلى "الأسس نت":

```
الأسس بداية.أسس انشر
```

<div dir=ltr>

```
alusus main.alusus publish
```

</div>

عند استدعاء أمر النشر ستبني المكتبة نسخة تنفيذية من المشروع ثم تطلب منك تسجيل الدخول بحساب "الأسس نت"
ثم تحمل المشروع إلى الخادم وتشغله تلقائيًا. اتبع التعيلمات التي ستظهر لك لإكمال النشر.


## المرجع

### إعـدادات (Config)

يحتوي الصنف على المتغيرات التالية:

* `اسم_المشروع: نـص` (`projectName: String`)
* `رقم_الإصدار: نـص` (`projectVersion: String`)
* `منفذ_الخادم: صـحيح` (`serverPort: Int`)
* `خيارات_الخادم: مـصفوفة[مـؤشر_محارف]` (`serverOptions: Array[CharsPtr]`) - يستخدم هذا المعطى لتحديد
  معطيات خادم Http في حال طلبنا من الناشر إنشاء الدالتين الرئيسيتين.
* `مسار_الموارد_الرئيسية_لمنصة_ويب: نـص` (`webPlatformMainAssetsPath: String`) - مسار الموارد الرئيسية
  الذي تحتاج إليه مكتبة مـنصة_ويب. يُهمل في حال لم يُطلب من الناشر إنشاء الدالتين الرئيسيتين.
* `مسار_المنافذ_المرئية_لمنصة_ويب: نـص` (`webPlatformUiEndpointsPath: String`) - مسار ملفات المنافذ
  المرئية الذي تحتاج إليه مكتبة مـنصة_ويب. يُهمل في حال لم يُطلب من الناشر إنشاء الدالتين الرئيسيتين.
* `الموارد: تـطبيق[نـص، نـص]` (`assets: Map[String, String]`) - قائمة بمسارات الموارد التي يستخدمها البرنامج.
  ستُرفق هذه الموارد مع المشروع عند بنائه ونشره. مفتاح هذا التطبيق هو المسار المصدري للموارد بينما القيمة
  هي المسار الذي سيُستخدم عند بناء النسخة التنفيذية. لا تحتاج لتوفير مسارات الموارد المشمولة ضمن تعريفات
  الموارد في الشفرة المصدرية، أي تلك المعرفة باستخدام المبدل `@مسار_موارد` (`@assetsRoute`).
* `الاعتماديات: مـصفوفة[نـص]` (`dependencies: Array[String]`) - قائمة المكتبات التي يحتاج إليها المشروع
  أثناء البناء.
* `مشغل_النشر: سـندنا[مـشغل_نشر]` (`publishDriver: SrdRef[PublishDriver]`) - المشغل المُستخدم لنشر المشروع.
* `وحدات_الخادم: سـند[كـائن_بهوية]` (`serverModules: ref[TiObject]`) - سند إلى الوحدة أو الوحدات التي
  تحتاج إليها مـنصة_ويب أثناء تشغيل وبناء المشروع.
* `بداية_آنية: سـند[كـائن_بهوية]` (`startJit: ref[TiObject]`) - سند إلى دالة تشغيل الخادم المخصصة للتشغيل
  المباشر. في حال عدم توفير هذه الدالة وكان المشروع يستخدم مـنصة_ويب سيتولى الناشر إنشاء الدالة بنفسه.
  هذه الدالة لا تستلم أي معطيات ولا تترجع أي قيم.
* `بداية_مبنية: سـند[كـائن_بهوية]` (`startExe: ref[TiObject]`) - سند إلى دالة مدخل البرنامج المستخدمة في
  حالة إنشاء نسخة تنفيذية من المشروع. في حال عدم توفير هذه الدالة وكان المشروع يستخدم مـنصة_ويب سيتولى
  الناشر إنشاء هذه الدالة بنفسه. تعريف هذه الدالة يجب أن يطابق الدالة الرئيسية (main) للبرنامج.
* `مهيئ: سـند[كـائن_بهوية]` (`initializer: ref[TiObject]`). معطى اختياري، وهو سند إلى دالة تهيئة ستُستدعى
  من دالتي البداية قبل بدء الخادم في حال اختار المستخدم الاعتماد على الناشر لتوليد هاتين الدالتين. هذه
  الدالة لا تستلم أي معطيات ولا ترجع أي قيم. لا يجوز توفير هذا المعطى في حال وفر المستخدم دالتي البداية بنفسه.

### ابن (build)

دالة لبناء المشروع. تُنشئ هذه الدالة ملفا تنفيذيا للمشروع وتنسخ الموارد المطلوبة إلى مجلد البناء.
تُستدعى هذه الدالة من الماكرو `ابدأ`.

```
دالة ابن [بداية: سند_شبم، وحدات: سـند_شبم] ()
```

<div dir=ltr>

```
func build [start: ast_ref, modules: ast_ref] ()
```

</div>

المعطيات:
* `بداية` (`start`): معطى قالب يشير إلى دالة مدخل البرنامج التنفيذي.
* `وحدات` (`modules`): معطى قالب يشير إلى الوحدة أو الوحدات التي تحتوي منافذ الخادم.

### انشر (publish)

دالة لنشر المشروع باستخدام المشغل المحدد عند التهيئة. يجب بناء المشروع باستخدام دالة `ابن` قبل استدعاء هذه الدالة.
هذه الدالة تُستدعى تلقائيا عند طلب نشر المشروع بالطريقة المعيارية للناشر.

### المشغلات

#### مـشغل_الأسس_نت (AlususNetDriver)

لنشر التطبيق على خدمة الأسس نت. لتهيئة المشغل:

```
مـشغل_الأسس_نت()؛
مـشغل_الأسس_نت(اسم_المشروع_للنشر: نـص)؛
```

<div dir=ltr>

```
AlususNetDriver();
AlususNetDriver(publishProjectName: String);
```

</div>

في حالة المُهيئ الأول، سيستخدم المشغل اسم المشروع من الإعدادات، بينما في حالة المُهيئ الثاني سيوفر
المستخدم اسما مختلفا للنشر على منصة الأسس نت. هذا مفيد في الحالات التي نرغب فيها باستخدام اسم في
سطر الأوامر مختلف عن الاسم الذي يستخدم للنشر على الأسس نت، حيث أن للأسس نت متطلبات أكثر صرامة فيما
يتعلق باسم المشروع.

### مـشغل_بروتوكول_النقل_الآمن (SshDriver)

لنشر التطبيق عبر بروتوكل SSH إلى أي خادم أو خدمة تدعم هذا البروتوكول. لتهئية المشغل:

```
مـشغل_بروتوكول_النقل_الآمن()؛
مـشغل_بروتوكول_النقل_الآمن(
    اسم_المستخدم: نـص،
    عنوان_الخادم: نـص،
    المنفذ: صـحيح،
    المسار_على_الخادم: نـص،
    اسم_الخدمة: نـص
)؛
```

<div dir=ltr>

```
SshDriver();
SshDriver(
    username: String,
    host: String,
    port: Int,
    serverPath: String,
    serviceName: String
);
```

</div>

الصيغة الأولى تجعل المشغل يسأل المستخدم أثناء النشر عن المعلومات المطلوبة للنشر، بينما الصيغة
الثانية توفر له المعلومات برمجيا.

المعطيات الثلاثة الأولى هي البيانات المطلوبة للاتصال باستخدام
بروتوكل SSH، بينما المعطى الرابع هو المسار على الخادم الذي ستنسخ له ملفات المشروع.

المعطى الخامس اختياري، ويحدد اسم خدمة systemd التي تشغل المشروع. عند توفير اسم الخدمة سيُعاد
تشغيلها تلقائيا بعد النشر.

</div>

